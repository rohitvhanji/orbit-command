<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loom | Precision Scheduling</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --slack-purple:#4A154B;
  --slack-green:#2EB67D;
  --slack-amber:#ECB22E;
  --slack-red:#E01E5A;
  --slack-border:#E2E2E2;
}

body,html{
  margin:0;height:100%;font-family:-apple-system,system-ui;
}

#app-shell{display:flex;height:100%}
#sidebar{
  width:340px;
  background:var(--slack-purple);
  color:white;
  display:flex;
  flex-direction:column;
}
.sidebar-header{padding:16px;font-weight:900}

.mgmt-section{padding:12px}
.mgmt-input{width:100%;padding:8px;margin-bottom:6px}

#member-groups{flex:1;overflow:auto}

#main-view-container{flex:1;display:flex;flex-direction:column}

#map-area{flex:1;background:#000;position:relative}
#map-bg{
  width:100%;height:100%;
  background:url('https://upload.wikimedia.org/wikipedia/commons/8/83/Equirectangular_projection_SW.jpg');
  background-size:100% 100%;
}

#rec-view{
  display:none;
  flex:1;
  background:#fff;
  padding:30px;
  overflow:auto;
}

.chart-row{display:flex;align-items:center;margin-bottom:6px}
.chart-label{
  width:140px;
  font-size:0.7rem;
  font-weight:800;
  color:var(--slack-purple);
  display:flex;
  gap:6px;
  align-items:center;
}
.chart-grid{flex:1;display:flex;gap:3px}
.chart-box{
  flex:1;
  height:32px;
  border-radius:4px;
  border:1px solid var(--slack-border);
}
.match-row .chart-box{cursor:pointer}

#scheduler{
  padding:10px;
  border-top:1px solid var(--slack-border);
  display:flex;
  gap:8px;
  align-items:center;
}
</style>
</head>

<body>

<div id="app-shell">
  <aside id="sidebar">
    <div class="sidebar-header">LOOM</div>

    <div class="mgmt-section">
      <input id="cityInput" class="mgmt-input" placeholder="City">
      <button onclick="lookupCity()">ADD OFFICE</button>
    </div>

    <div class="mgmt-section">
      <input id="newName" class="mgmt-input" placeholder="Name">
      <select id="newLoc" class="mgmt-input"></select>
      <button onclick="addMember()">ADD TEAMMATE</button>
    </div>

    <div id="member-groups"></div>
  </aside>

  <main id="main-view-container">
    <div id="map-area">
      <div id="map-bg"></div>
    </div>

    <div id="rec-view">
      <button onclick="toggleView('map')">‚Üê Back</button>
      <h2 style="color:var(--slack-purple)">Match Grid</h2>
      <div id="match-grid"></div>
    </div>

    <footer id="scheduler">
      <input type="date" id="schedDate">
      <input type="number" id="hourVal" min="0" max="23" placeholder="HH">
      <select id="minVal">
        <option value="00">60m</option>
        <option value="30">30m</option>
      </select>
      <button onclick="setFitMode(true)">SIMULATE</button>
      <button onclick="showMatchGrid()">BEST TIME</button>
      <button onclick="resetToLive()">LIVE</button>
      <div id="predictVal">0% Harmony</div>
    </footer>
  </main>
</div>

<script>
const _supabase = supabase.createClient(
  'https://xcdnyheqtagizlcyzuzb.supabase.co',
  'sb_publishable_5cH3NNSKN1knnkm6ZMvggw_6RQdq9Nh'
);

let locationData={},team=[];
let isFitMode=false,workDate=new Date();
let excludedTzs=new Set();

function getInterval(){
  return document.getElementById('minVal').value==="30"?30:60;
}

function toggleView(v){
  document.getElementById('map-area').style.display=v==='map'?'block':'none';
  document.getElementById('rec-view').style.display=v==='rec'?'block':'none';
}

function getStatus(d){
  const h=d.getHours(),w=d.getDay();
  if(w===0||w===6) return{work:false,color:'#ccc'};
  if(h>=9&&h<17) return{work:true,color:'var(--slack-green)'};
  return{work:false,color:'var(--slack-red)'};
}

function calculateFilteredHarmony(t){
  const utc=t.getTime()+t.getTimezoneOffset()*60000;
  const filtered=team.filter(m=>{
    const l=locationData[m.loc];
    return l && !excludedTzs.has(l.tz);
  });
  if(!filtered.length) return 0;
  let on=0;
  filtered.forEach(m=>{
    const l=locationData[m.loc];
    const local=new Date(utc+l.offset*3600000);
    if(getStatus(local).work) on++;
  });
  return Math.round(on/filtered.length*100);
}

function showMatchGrid(){
  const base=document.getElementById('schedDate').value
    ? new Date(document.getElementById('schedDate').value+"T00:00:00")
    : new Date();

  const interval=getInterval();
  const steps=1440/interval;
  const grid=document.getElementById('match-grid');
  grid.innerHTML='';

  const tzs=[...new Set(Object.values(locationData).map(l=>l.tz))];

  tzs.forEach(tz=>{
    const loc=Object.values(locationData).find(l=>l.tz===tz);
    let row=`<div class="chart-row">
      <div class="chart-label">
        <input type="checkbox" ${excludedTzs.has(tz)?'':'checked'}
          onchange="toggleExclude('${tz}')">${tz}
      </div><div class="chart-grid">`;

    for(let i=0;i<steps;i++){
      const t=new Date(base.getTime()+i*interval*60000);
      const local=new Date(t.getTime()+t.getTimezoneOffset()*60000+loc.offset*3600000);
      row+=`<div class="chart-box" style="background:${getStatus(local).color}"></div>`;
    }
    grid.innerHTML+=row+'</div></div>';
  });

  let match=`<div class="chart-row match-row">
    <div class="chart-label">MATCH</div><div class="chart-grid">`;

  for(let i=0;i<steps;i++){
    const t=new Date(base.getTime()+i*interval*60000);
    const s=calculateFilteredHarmony(t);
    const c=s>=75?'var(--slack-green)':s>=40?'var(--slack-amber)':'var(--slack-red)';
    match+=`<div class="chart-box" style="background:${c}"
      onclick="selectMatch('${t.toISOString()}')"></div>`;
  }
  grid.innerHTML+=match+'</div></div>';

  toggleView('rec');
}

function toggleExclude(tz){
  excludedTzs.has(tz)?excludedTzs.delete(tz):excludedTzs.add(tz);
  showMatchGrid();
}

function selectMatch(iso){
  workDate=new Date(iso);
  isFitMode=true;
  document.getElementById('hourVal').value=workDate.getHours();
  document.getElementById('minVal').value=workDate.getMinutes()===30?'30':'00';
  render();
}

function render(){
  const ref=isFitMode?workDate:new Date();
  document.getElementById('predictVal').innerText=
    calculateFilteredHarmony(ref)+"% Harmony";
}

function setFitMode(v){isFitMode=v;render()}
function resetToLive(){isFitMode=false;toggleView('map');render()}
</script>

</body>
</html>
