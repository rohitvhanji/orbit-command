<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loom | Precision Scheduling</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
    --slack-purple:#4A154B;
    --slack-navy:#3F0E40;
    --slack-blue:#1264A3;
    --slack-green:#2EB67D;
    --status-lunch:#ECB22E;
    --status-snooze:#E01E5A;
    --status-weekend:#888;
    --night-wash:rgba(8,14,32,.85);
}
html,body{margin:0;height:100%;font-family:-apple-system}
#app-shell{display:flex;height:100%}
#sidebar{width:320px;background:var(--slack-purple);color:#fff;overflow:auto}
#member-groups{padding-bottom:80px}
.member-row{display:flex;justify-content:space-between;padding:6px 15px}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:8px}
#map-area{flex:1;position:relative;background:#000}
#map-bg{position:absolute;inset:0;background:url('https://upload.wikimedia.org/wikipedia/commons/8/83/Equirectangular_projection_SW.jpg') no-repeat;background-size:100% 100%;filter:saturate(.5)}
#svg-map{position:absolute;inset:0}
#scheduler{position:absolute;bottom:0;left:0;right:0;background:#fff;padding:10px;display:flex;gap:10px;justify-content:center}
</style>
</head>

<body>

<div id="app-shell">
<aside id="sidebar">
    <h2 style="padding:15px">LOOM</h2>
    <div id="member-groups"></div>
</aside>

<main style="flex:1;position:relative">
    <div id="map-area">
        <div id="map-bg"></div>
        <svg id="svg-map" viewBox="0 0 800 400" preserveAspectRatio="none">
            <g id="day-night-layer"></g>
            <g id="marker-layer"></g>
        </svg>
    </div>

    <footer id="scheduler">
        <input type="date" id="schedDate">
        <input type="number" id="hourVal" min="0" max="23" placeholder="HH">
        <select id="minVal"><option value="0">00</option><option value="30">30</option></select>
        <button onclick="setFitMode()">SIMULATE</button>
        <button onclick="resetToLive()">LIVE</button>
    </footer>
</main>
</div>

<script>
/* ================== CONFIG ================== */

const MY_OFFSET = 5.5; // IST
let isFitMode=false;
let workDate=new Date(); // ALWAYS UTC

/* Mock data so file runs standalone */
const locationData={
    Bangalore:{offset:5.5,tz:"IST",lon:77.6,lat:12.9},
    London:{offset:0,tz:"GMT",lon:-0.1,lat:51.5},
    NewYork:{offset:-5,tz:"EST",lon:-74,lat:40.7}
};
const team=[
    {name:"A",loc:"Bangalore"},
    {name:"B",loc:"London"},
    {name:"C",loc:"NewYork"}
];

/* ================== STATUS ================== */

function getStatus(d){
    const h=d.getHours(),day=d.getDay();
    if(day===0||day===6) return {emoji:"ðŸ–ï¸",color:"var(--status-weekend)"};
    if(h>=22||h<7) return {emoji:"ðŸ˜´",color:"var(--status-snooze)"};
    if(h>=9&&h<17) return {emoji:"ðŸ’»",color:"var(--slack-green)"};
    return {emoji:"ðŸ ",color:"var(--slack-blue)"};
}

/* ================== RENDER ================== */

function render(){
    const ref=isFitMode?workDate:new Date();
    const utcMs=ref.getTime();

    const c=document.getElementById("member-groups");
    c.innerHTML="";

    Object.entries(locationData).forEach(([city,l])=>{
        const local=new Date(utcMs+(l.offset*3600000));
        const s=getStatus(local);
        team.filter(t=>t.loc===city).forEach(m=>{
            c.innerHTML+=`
            <div class="member-row">
                <div><span class="status-dot" style="background:${s.color}"></span>${m.name} (${city})</div>
                <div>${local.getHours().toString().padStart(2,"0")}:${local.getMinutes().toString().padStart(2,"0")} ${s.emoji}</div>
            </div>`;
        });
    });

    drawMap(ref);
}

/* ================== MAP ================== */

function drawMap(ref){
    const night=document.getElementById("day-night-layer");
    night.innerHTML="";
    const utcHour=ref.getUTCHours()+ref.getUTCMinutes()/60;

    for(let i=0;i<24;i++){
        const lon=i*15-180;
        const hr=Math.floor((24+utcHour+(lon/15))%24);
        if(hr<6||hr>=18){
            const r=document.createElementNS("http://www.w3.org/2000/svg","rect");
            r.setAttribute("x",(lon+180)*2.222);
            r.setAttribute("width",33.4);
            r.setAttribute("height",400);
            r.setAttribute("fill","var(--night-wash)");
            night.appendChild(r);
        }
    }
}

/* ================== CONTROLS ================== */

function setFitMode(){
    const d=schedDate.value;
    if(!d) return alert("Select date");
    const h=parseInt(hourVal.value)||0;
    const m=parseInt(minVal.value)||0;

    // IST wall-clock â†’ UTC
    const istUTC=Date.UTC(
        +d.slice(0,4),
        +d.slice(5,7)-1,
        +d.slice(8,10),
        h,m
    );
    workDate=new Date(istUTC-(MY_OFFSET*3600000));
    isFitMode=true;
    render();
}

function resetToLive(){
    isFitMode=false;
    render();
}

/* ================== INIT ================== */

render();
</script>
</body>
</html>
