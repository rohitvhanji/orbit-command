<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Loom | Global Team Harmony</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
    --slack-purple:#4A154B;
    --slack-navy:#3F0E40;
    --slack-blue:#1264A3;
    --slack-green:#2EB67D;
    --slack-bg:#F0F2F5;
    --slack-border:#E2E2E2;

    --status-lunch:#ECB22E;
    --status-snooze:#E01E5A;

    /* UPDATED: blue-black night overlay */
    --night-wash: rgba(8, 14, 32, 0.85);

    --weekend-grey:#9CA3AF;
    --loom-gradient:linear-gradient(135deg,#4A154B 0%,#2c0b2d 100%);
}

body,html{
    margin:0;padding:0;width:100%;height:100%;
    font-family:-apple-system,sans-serif;
    background:white;overflow:hidden;
}

/* --- UI unchanged --- */
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth-overlay">
    <div class="auth-card">
        <input type="email" id="auth-email" class="mgmt-input" placeholder="Email" style="color:black">
        <input type="password" id="auth-pass" class="mgmt-input" placeholder="Password" style="color:black">
        <button onclick="handleAuth()">LOGIN</button>
        <div id="auth-status"></div>
    </div>
</div>

<div id="app-shell">
<aside id="sidebar">
    <div class="sidebar-header">
        <h2>LOOM</h2>
        <span onclick="logout()">Logout</span>
    </div>

    <div class="mgmt-section">
        <input id="cityInput" class="mgmt-input" placeholder="City nameâ€¦">
        <button onclick="lookupCity()">ADD OFFICE</button>
    </div>

    <div class="mgmt-section">
        <input id="newName" class="mgmt-input" placeholder="Nameâ€¦">
        <select id="newLoc" class="mgmt-input"></select>
        <button onclick="addMember()">ADD TEAMMATE</button>
    </div>

    <div id="member-groups"></div>
</aside>

<main id="main-view-container">
    <div id="map-area">
        <div id="map-bg"></div>
        <svg id="svg-map" viewBox="0 0 800 400" preserveAspectRatio="none">
            <g id="day-night-layer"></g>
            <g id="grid-label-layer"></g>
            <g id="marker-layer"></g>
        </svg>
    </div>

    <!-- UPDATED SCHEDULER -->
    <footer id="scheduler">
        <input type="date" id="schedDate">
        <input type="number" id="hourVal" min="0" max="23" placeholder="HH">

        <!-- NEW: minute selector -->
        <select id="minuteVal">
            <option value="0">00</option>
            <option value="30">30</option>
        </select>

        <button onclick="setFitMode(true)">SIMULATE</button>
        <button onclick="resetToLive()">LIVE</button>
        <div id="predictVal">0% Harmony</div>
    </footer>
</main>
</div>

<script>
/* ---------------- HELPERS ---------------- */

function isWeekend(d){
    const day=d.getDay();
    return day===0 || day===6;
}

/* UPDATED: weekend-aware status */
function getStatus(hr, refDate){
    if(isWeekend(refDate)){
        return { emoji:"ðŸ“´", color:"var(--weekend-grey)", work:false };
    }
    if(hr>=22 || hr<7) return { emoji:"ðŸ˜´", color:"var(--status-snooze)", work:false };
    if(hr>=13 && hr<14) return { emoji:"ðŸ±", color:"var(--status-lunch)", work:true };
    if(hr>=9 && hr<17) return { emoji:"ðŸ’»", color:"var(--slack-green)", work:true };
    return { emoji:"ðŸ ", color:"var(--slack-blue)", work:false };
}

/* ---------------- RENDER ---------------- */

function render(){
    const ref=isFitMode?workDate:new Date();
    const container=document.getElementById('member-groups');
    container.innerHTML='';

    let total=team.length,available=0;
    const utcBase=ref.getTime()+ref.getTimezoneOffset()*60000;

    Object.values(locationData).forEach(loc=>{
        const local=new Date(utcBase+loc.offset*3600000);
        const s=getStatus(local.getHours(),ref);
        if(s.work) available++;
    });

    document.getElementById('predictVal').innerText=
        total?Math.round((available/total)*100)+"% Harmony":"0%";

    drawMap(ref);
}

/* ---------------- MAP ---------------- */

function drawMap(refDate){
    const night=document.getElementById('day-night-layer');
    night.innerHTML='';
    const utcHour=refDate.getUTCHours()+refDate.getUTCMinutes()/60;

    for(let i=0;i<24;i++){
        const lon=i*15-180;
        const x=(lon+180)*2.222;
        const hr=Math.floor((24+utcHour+lon/15)%24);
        if(hr<6||hr>=18){
            const r=document.createElementNS("http://www.w3.org/2000/svg","rect");
            r.setAttribute("x",x);
            r.setAttribute("y",0);
            r.setAttribute("width",33.4);
            r.setAttribute("height",400);
            r.setAttribute("fill","var(--night-wash)");
            night.appendChild(r);
        }
    }
}

/* ---------------- SIMULATE ---------------- */

function setFitMode(v){
    const h=parseInt(hourVal.value)||0;
    const m=parseInt(minuteVal.value)||0;
    const d=schedDate.value;
    if(!d) return alert("Select a date");
    workDate=new Date(`${d}T${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`);
    isFitMode=v;
    render();
}

function resetToLive(){isFitMode=false;render();}
</script>

</body>
</html>
